# 第四章：异步系统调用框架设计
## 4.1 异步系统调用设计
异步系统调用架构分为用户态和内核态两个部分：

在用户态中，异步系统调用框架提供的异步协程运行时主要提供两部分支持：首先是持有一个封装了接收内核处理响应执行流的协程并发运行，允许用户态在等待系统调用结果时可以执行其他协程来减少CPU等待时间；其次是封装一系列异步系统调用方法来提交异步系统调用。

在内核态中，异步系统调用框架提供的异步协程运行时主要提供两部分支持：首先是持有一个封装了接收异步系统调用执行流的处理协程并发运行，此协程将被允许运行在其他空闲CPU，且与线程一一对应；其次是封装一系列处理方法方法来执行异步系统调用并返回结果。

用户态和内核态的交互通过共享内存块、唤醒内核协程的系统调用和Notification机制三个方面进行：

如图所示，共享内存块将被按照特定的数据结构解析，异步系统调用框架要求用户态和内核态运行对共享内存中数据结构的编码和解码一致。用户态对内核的异步系统调用请求将被写入共享内存，用户态接收响应协程的运行状态也将被维护在共享内存中。而内核态可以通过共享内存读取来自用户态的异步系统调用请求，并将处理后的响应写入共享内存中，同时，内核态接收请求协程的运行状态也将被维护在共享内存中。

当用户态发起请求但内核态接收请求协程不在线时，用户态运行时就会调用唤醒内核协程的系统调用陷入内核，内核将寻找空闲的CPU核心并发送核间中断（Inter-Core Interrupt，IPI），被选择的CPU核心接收IPI并陷入内核，使用一个名为idle线程的代理线程来唤醒并运行选择陷入内核的线程对应的接收系统调用请求的内核协程，实现同时并行处理。

当内核协程处理完请求但用户态运行时的接收内核处理响应的协程不在线时，内核将使用Notification机制向目标线程发送信号，唤醒对应的处理协程接收响应。

![](../images/async-syscall-design.png)

## 4.2 异步系统调用工作流程
在用户态中，异步系统调用的工作流程如下所示：
1. 申请共享内存用于存放系统调用请求参数和请求结果等数据
2. 生成notification内核对象
3. 生成用户态coroutine接收请求协程并注册为用户态中断接收协程
4. 使用系统调用，将共享内存和notification内核对象作为入参注册异步系统调用
5. 提交异步系统调用请求

当用户态注册异步系统调用后，内核态将会生成内核处理协程不断接收异步系统调用请求。该协程会遍历共享内存中的系统调用请求并解码处理，当没有请求时会挂起该协程。需要指出的是，线程、共享内存和内核协程三者是一一对应的。在此基础上，内核态的异步系统调用的工作流程如下所示：

1. 从共享内存中取出系统调用条目
2. 对条目和入参进行解码并分发处理
3. 将处理结果写回共享内存
4. 若用户态接收协程不在运行状态则发送用户态中断通知唤醒

## 4.3 本章小结
本章主要介绍了异步系统调用的框架设计和具体工作流程。异步系统调用框架在原有同步系统调用的基础上引入了异步的思想，力求提升系统的并发性以提高运行性能。在此基础引入了新兴的用户态中断硬件机制改造的Notification机制作为底层交互工具，具有良好的创新型。