# 答辩PPT讲稿

## 介绍

各位开源社区的老师、同学大家好，我是陈伟豪，本科毕业于北京理工大学，现在在北京航空航天大学的操作系统实验室攻读研究生，我报告的主题是《基于用户态中断的异步系统调用设计》。这个项目是我参与的2023年的开源社区的开源毕设项目，我的指导老师是陆慧梅老师、向勇老师以及吴竞邦老师。

我将从以下几个部分介绍我的毕业设计工作内容。

第一部分主要介绍项目的背景以及研究意义，包括在微内核结构中优化IPC与系统调用成本的有关研究。

第二部分主要介绍项目选用的技术——用户态中断以及实现异步系统调用框架所选用的平台ReL4微内核

第三部分是本次报告的主要内容，主要介绍异步系统调用框架的设计原理、工作流程以及部分核心数据结构的实现。

第四部分主要介绍对异步系统调用框架的性能测试以及结果分析。

第五部分主要介绍项目总结和展望以及我参加开源毕设项目的心得体会。

## 第一部分：研究背景

首先进入第一部分，研究背景。

由于微内核结构的特殊性，低IPC与系统调用成本至关重要。

此前优化的相关工作主要分为三个部分：提升多核利用率、减少内核路径与减少特权级切换开销。其中，由于前两部分的优化已经趋于极限，减少特权级切换开销成为了优化的主要方向。在这样的现状下，我结合用户态中断提出了改进方案。用户态中断无需陷入内核即可发送信号，避免了特权级切换，具有了更好的通信性能。

所以，本项目在于利用用户态中断机制改进后的Notification机制，对系统调用进行异步化改造，减少特权级切换频率，以此减少开销，提升系统性能。

## 第二部分：用户态中断及REL4微内核介绍

下面进入第二部分，用户态中断及REL4微内核介绍。

ReL4是本次毕设的开发平台，是Rust重写seL4支持RISC-V接口的微内核，它的结构如图1所示，从图中可以看出，这些模块提供基本的内核支持：系统调用处理、中断处理、进程管理、进程间通信、内存管理（内存分配在用户态）Capability机制

我工作为Async Runtime模块，其内实现了异步系统调用的相关方法，包括共享内存的解析、用户态异步系统调用发起接口以及内核态
异步系统调用处理函数，它以基于用户态中断的Notification机制为基础。



下面为大家简要介绍一下Capability机制：

首先，内核把内核中的Notification、空闲内存等资源抽象为内核对象，而Capability则是在用户态访问内核对象的token，这个token包含了访问权限集合，每个进程都有独立的Capability空间——CSpace，Capability机制为内核提供了安全和隔离的效果。



下面为大家简要介绍一下用户态中断。

用户态中断是一种新兴的硬件技术方案。它通过硬件的方式，在无需陷入内核的情况下，将信号发送给其他用户态程序。该机制仅需在通信注册过程中陷入内核，以分配用于通信的相关硬件资源，后续的通信过程无需内核接入，很好地避免了用户态和内核态的上下文切换。目前已经在Sapphire Rapids x86处理器上和RISC-V的N扩展中得到支持。



用户态中断包括接收端和发送端：接收端是一个用户进程，他需要提供处理函数，并使用处理函数向kernel将自己注册为接收端，kernel会返回一个独有的标识符，接收端通过FD将标识符分享给发送端。发送端是一个用户进程或者内核，它使用接收端提供的标识符向Kernel注册自己为发送端，并可以使用SENDUIPI指令，以标识符为参数发送用户态中断。在这个过程中，Kernel只维护必要的数据结构，如标识符和索引表等，并且只在通信建立阶段干预。



下面为大家简要介绍一下基于用户态中断的Notification机制。在SeL4或ReL4内核中，Notification原先是一种非阻塞的信号机制。而在本次项目中，我们基于用户态中断对Notification机制进行了修改：我们将UINT的硬件资源索引以及维护集成到Notification对象中，并在在建立Notification通信机制的过程中同时建立用户态中断机制。此外，我们将原有的Notification通信机制的接口实现进行了修改，将用户态中断的通信接口替换到Notification机制接口中。



## 第三部分：异步系统调用框架设计

下面进入第三部分。

图2是异步系统调用的框架图，这部分是本设计的核心内容。在图中可以看到，用户态、内核态都配备异步运行时模块。

图中设计内容可以分为三个部分：

首先是用户态异步运行时，它包含一个接收协程和多个提交协程，提交协程通过调用提交函数提交异步系统调用请求，接受协程用于接受内核处理的系统调用请求。

然后是内核态异步运行时，它包含一个处理协程，还有一系列处理函数。处理协程通过循环读取共享内存中的请求，并调用处理函数进行处理。内核协程可以在本核心上运行，在时钟中断到来时集中并发处理请求，也可以在其他核心上运行，实现并行处理。处理协程在没有请求时将被挂起。

最后是用户态与内核态的交互部分，二者的交互通过Rust协程进行，交互内容，如系统调用参数、处理结果，将写入共享内存。用户态协程唤醒内核协程采用新增的系统调用，内核协程唤醒用户协程采用基于用户态中断的Notification机制。



在使用异步系统调用框架前需要在用户态使用系统调用接口进行注册，注册流程如下：

内核与用户态协程的工作流程也如图所示，核心就是循环读取共享内存中的请求。



有了框架，在具体实现中，我们还需解决如下三个问题：

1. 由于用户态与内核态可能并发访问共享内存，所以共享内存需要实现互斥访问控制
2. 系统调用区分与参数传递
3. 协程实现

共享内存Syscall Buffer的实现如图3所示，其中包含两个维护协程状态的原子布尔变量以及两个IPC Queue分别用于储存请求和响应。IPCQueue的元素为IPCItem，Request IPC Queue由用户态写入，内核态读取；Result IPC Queue由内核态写入，用户态读取；互斥访问的实现采用原子布尔，其写操作具有原子性，而IPC Queue通过互斥锁Mutex实现用户态与内核态的访问控制。

对于系统调用参数传递，如图11所示，Item内的MessageInformation成员用于区分系统调用，而ExtendMessage成员用于传递系统调用参数。

协程的实现如图12所示，两类协程中都包含了处理方法以及必要的数据结构来进行系统调用参数传递、解析，以及进行协程间通信。内核协程中包括了共享内存的引用，还要TCB内核对象的引用，用于解析CSpace以及Capability，还有UITTE标识符，用于发送用户态中断。



在本次毕设中我对下面四种系统调用实施了异步化改造



## 第四部分：实验与结果分析

下面进入第四部分，实验与结果分析。



而系统的性能测试选择在不同并发环境下提交一定量的系统调用请求，并比较异步实现与原有同步实现的处理速度和特权级切换开销。由于FPGA开发板更接近真实的硬件性能，因此报告展示数据为源于FPGA开发板，Qemu模拟器数据见论文。

首先，从每轮测试耗时的指标上看：横轴为并发度，纵轴为每轮所占时钟周期数，表征处理速度，越低越好。在低并发环境下改进后性能低于改进前，这是因为内核协程负载低，完成处理后自我阻塞，导致用户协程需要不断陷入唤醒内核协程。在高并发环境下改进后性能可以达到同步实现的130%，具有良好的性能优势。

其次，从陷入频率的指标上看：横轴为并发度，纵轴为陷入频率，表征特权级切换开销。改进前的陷入频率恒为1，而改进后的陷入频率远低于同步实现。这体现出本设计的工作达到了减少特权级切换频率的目的。

## 第五部分：总结与展望

下面进入第五部分，总结与展望。

在本次毕业设计中，我的工作为引入异步化思想，结合了共享内存通信内容丰富与用户态中断机制方式快捷有效的优势，并发、集中处理大量系统调用，最终实现异步系统调用框架。结果表明在高并发环境下异步系统调用具有优于原有实现的性能。

未来的发展中可以通过优化异步系统调用框架性能、增加内核协程数量以及实现调度器动态选择同步与异步接口的方式来获得更好的系统性能。

## 结尾

以上就是我的毕设工作，感谢各位专家老师，请您批评指正！

# 答辩问题

Q：毕业设计的创新点？

A：毕设工作的研究创新点在于在系统调用的设计实现中引入了异步的思想，能够并发且集中地在内核态处理大量的系统调用请求，这是以往的同步系统调用所无法实现的，适用于存在大量系统调用需求的应用场景。此外，本文工作将常用的共享内存通信方式与用户态中断机制进行了结合，结合了共享内存通信通信量大且通信内容丰富与用户态中断机制方式快捷有效的优势。

Q：如何使用的用户态中断？

A：首先，在异步系统调用的注册流程中就需要将用户态接收协程生成，并将其注册为用户态中断接收协程，这样用户态中断处理例程就可以在信号到来时唤醒它。而在注册异步系统调用时内核协程也将获得对应的UITTE，可以向用户协程发送用户态中断。

Q：为什么选用共享内存？

A：原有的系统调用采用消息寄存器的方式传递参数，而异步系统调用的内核处理协程可能在其他核心上运行，无法读取对应消息寄存器内容，因此需要考虑其他实现方式。信号量的方式可以传递的参数有限，而共享内存提供的大空间就可以满足这一需求。

Q：为什么选用处理速度和陷入频率指标？

A：处理速度指标可以最直观的体现异步系统调用框架的性能，而陷入频率指标可以反映是否达到了研究初所确定的减少特权级切换频率的研究目的。

# 
