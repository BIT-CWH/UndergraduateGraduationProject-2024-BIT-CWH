# 2024年开源毕设总结

作者：陈伟豪

北京理工大学 计算机学院 计算机科学与技术2020级本科生

2024年6月10日

## 目录

<!-- TOC -->
- [2024年开源毕设总结](#2024年开源毕设总结)
  - [目录](#目录)
  - [前言](#前言)
  - [第一章 加入CSCW](#第一章-加入cscw)
    - [1.1 我与系统编程的缘分](#11-我与系统编程的缘分)
    - [1.2 成功进组](#12-成功进组)
  - [第二章 准备工作](#第二章-准备工作)
    - [2.1 学习Rust编程](#21-学习rust编程)
    - [2.2 学习rCore-Tutorial](#22-学习rcore-tutorial)
    - [2.3 环境搭建](#23-环境搭建)
    - [2.4 同步IPC测试](#24-同步ipc测试)
  - [第三章 异步系统调用框架开发](#第三章-异步系统调用框架开发)
    - [3.1 跑通基本流程](#31-跑通基本流程)
    - [3.2 翻译系统调用](#32-翻译系统调用)
  - [第四章 论文撰写与答辩准备](#第四章-论文撰写与答辩准备)
    - [4.1 论文撰写](#41-论文撰写)
    - [4.2 答辩准备](#42-答辩准备)
  - [完结](#完结)
  - [附录](#附录)
    - [文档仓库](#文档仓库)
    - [代码仓库](#代码仓库)

<!-- /TOC -->

## 前言

随着最终版毕业论文的提交，我的毕业设计工作也算是落下帷幕。在向老师、陆老师、吴老师的指导下，我的工作最终获得了良好的等级，也算是完成了学期初定下的目标。一路走来，感触良多。谨以此文回忆、总结我的毕业设计工作。

## 第一章 加入CSCW

### 1.1 我与系统编程的缘分

陆老师是我们大学三年级时《操作系统》课程的老师。老师在上课时认真地为我们讲授操作系统的知识，课间也会和我们分享学习、生活方面的经验，课后认真解答同学们的问题。有一次我从《移动互联系统开发与设计》课程下课去上《操作系统》课的时候碰到老师，老师还和我攀谈了一会儿此刻的内容。这件事给我留下了很深的印象，我切身地感受到，陆老师是一个亲切、真心关心学生的老师。因此，课堂的学习氛围很好，我也对操作系统渐渐产生了兴趣，在最终的考试中也获得了优异的成绩。

在课程的进展过程中，陆老师时常向我们推荐学习rCore训练营的实验，提出了学习rCore实验可以抵扣课程实验的优惠政策。老师还在课程群中宣传操作系统大赛，鼓励大家参赛。当时的我对实验和比赛有一定的兴趣，有参加比赛的想法。但是因为大学以来没有参加过什么比赛，加上对自己能力的不自信，害怕自己加入以后也没能力完成，因此我最终没有报名参加。随着课程的结束，这些事也就不了了之了。后来，陈林峰学长和林晨同学在当年的大赛中拿了特等奖，在为他们感到高兴的同时，自己内心也充满了羡慕。

说来也巧，计算机系统类课程都排在大学三年级进行：《操作系统》、《汇编语言与接口设计》、《计算机系统导论》、《计算机组成原理与体系结构》、《计算机网络》。在这些课程的学习过程中，我都能做到快速掌握，并将知识融会贯通，最终都取得了优异的成绩，排在专业前列。这些课程的学习增长了我的自信心，也让我发现了自己在系统领域的兴趣。因此，我产生了在研究生阶段在系统方向深入研究的想法。

### 1.2 成功进组

加入开源毕设的事情还要从2023年11月份开始说起，彼时的我还在准备考研初试。虽然当时学院还没有发布选择毕设指导老师的通知，但我已经在考虑导师选择的事情了。考虑到自己对系统领域的兴趣，以及曾上过陆老师的《操作系统》课程，我萌生了选择陆老师为指导老师的意向。我深知系统编程不是一件容易掌握的事。但思索再三后，我怀着忐忑的心情给陆老师发送了我的简历。我的想法如下：

1. **想检验一下自己对系统编程是不是真感兴趣**
2. **系统编程不容易掌握，但是我愿意接受挑战，培养自己面对困难和解决问题的能力**
3. **正是因为系统编程不简单，老师一定会严格要求，这样也可以顺便适应一下研究生的生活，为日后科研打下基础**

几天后，陆老师回复了我的邮件，并对我参与开源毕设项目表示欢迎。老师先询问了我近期的学习情况，并询问我在下学期能否全力投入毕设工作。在得到了我肯定的答复后，老师提出让我先了解rCore训练的内容。于是，我报名的训练营的内容，发现内容新颖，培训内容循序渐进，这更加坚定了我加入开源毕设的决心。

又过了几天，陆老师把本年度的开源毕设题目清单发给了我，让我从中选择。接到清单的我一脸懵逼，因为上面的内容都是实际的科研项目，我几乎都没有见过（当然现在是看得懂的hhh），只能看懂一些课本上提到的概念。考虑到大学前三年在软件实现方面经验较多，我最终选择了《微内核ReL4中基于用户态中断的异步系统调用设计》。

随着考研初试结束，陆老师也联系我加入课题组开展毕设工作，并让我找廖东海学长对接工作。学长热情地向我推荐了两篇参考文献，并推荐我阅读seL4有关的教程。

在考研结束的第二天，实验室线上例会如期开展，我也第一次接触到了实验室的另外两位老师——清华大学的向勇老师以及来自北京工商大学的吴竞邦老师。向向老师和吴老师介绍过自己后，我就算正式加入CSCW的大家庭了。

## 第二章 准备工作

### 2.1 学习Rust编程

加入实验室后，老师们计划先让我完成rCore训练营第一阶段与第二阶段的内容（即完成Rust语言的学习以及rCore操作系统的学习），随后再完成毕设内容。为了更好地完成任务，我开始在中教803实验室学习。由于对Rust语言与Cargo的不熟悉，在环境部署的时候我就遇到了麻烦：rustlings指令无法运行。而在廖东海学长的帮助下，我的环境才成功配置完成。通过自主阅读《Rust程序设计语言》以及rCore训练营提供的教学视频，我快速地完成了rustlings的试题内容，对rust的语言的所有权、生命周期以及trait等特性有了简单的认识。完成这些内容大致花费了一周的时间。但是，由于接触Rust语言的时间很短，我自己觉得还是无法熟练地运用Rust语言。现在看来，**仅仅通过完成rustlings来达到对Rust的熟练掌握是远远不够的，还需要通过编写更多的程序来锻炼自己的能力。**

### 2.2 学习rCore-Tutorial

由于时间有限，在我在rustlings试题完成后并没有编写更多的代码，而是快速开始了rCore-Tutorial的学习。在rCore-Tutorial以及相关的教程文档中，我从了解应用程序与基本执行环境开始，并学习了批处理系统的代码实现。之后，在每章的实验中，rCore-Tutorial都会在批处理系统上引入不同的功能模块（如虚存管理、进程管理等），直到最终构建为一个类unix的操作系统。考虑到精简版的《rCore-Tutorial-Guide》一书删去了部分背景知识的介绍，为了更好地了解rCore代码实现背后的原理，我最终选择了阅读完整版的教程《rCore-Tutorial-Book-v3》。在每各章节的学习中，我采用“**2遍阅读教程+1遍对Vscode照源码学习教程+自主完成配套实验**”的学习方法，这个方法也得到了向老师的鼓励和认可。由于寒假临近，我也日渐放松下来，因此在寒假结束时我才完成了rCore-Tutorial的相关实验。但不得不说，通过学习rCore-Tutorial，我对操作系统的理解由原来的课本层面深入到了代码实现层面，知道一个操作系统是如何被构建起来的。此外，我也深化了对Rust语言所有权机制的认识，对如何避免引用借用造成的panic有了一些编程经验。

### 2.3 环境搭建

开学后，我匆匆忙忙地完成了学校的开题工作，并依照向老师的要求完成了学期计划。随后，我返回了803实验室，着手开始搭建ReL4的运行环境。一开始，我计划在VMWare的Ubuntu虚拟机上部署ReL4。但是由于VMWare虚拟机的网络设置不稳定，而且部署到一半发现一开始预计的50GB硬盘空间不够用，我最终放弃了这个方法，听从了学长的意见，采用WSL进行开发。在WSL上进行部署的过程也不是一帆风顺，我前前后后经历了riscv交叉编译工具无法编译、编译过程中虚拟机读写权限莫名报错等一系列奇奇怪怪的问题。有时候甚至担心，要是我最终没办法把环境部署起来，那是不是就没法顺利毕业了。好在廖东海学长一直热心地帮我思考解决办法，在我无能为力时上手解决各种各样的问题。甚至在交叉编译工具经过各种方法仍然无法编译时，学长把编译后的文件直接拷给了我。最终，在经历了小半周的折腾后，我终于在我的主机上把ReL4操作系统跑起来了，这一刻，我如释重负。在向老师的建议下，我把部署的过程整理成了一份帮助文档，以便后续的同学使用。

### 2.4 同步IPC测试

部署完第一项工作后，为了更好地了解ReL4的代码结构，顺便协助学长分析ReL4的IPC性能，我把熟悉ReL4的IPC代码路径并完成路径上各部分的时钟周期占比作为了我的工作内容。

首先进行的是同步IPC的测试内容。为了更好地了解其中的数据结构，我阅读了学长撰写的seL4（ReL4前身）分析文档，知道了ReL4中的Capability机制以及Notification、EndPoint等内核对象的运作机制。在学长的指点下，我开始在同步IPC的代码路径上打上时间戳进行时钟占比的分析。在内核态与用户态的时钟周期占比分析可以直接使用Rust封装的函数进行，简单易做；内核态与用户态中还有一段汇编语言作为连接，测算其中的代码路径就具有一定难度。在经过了一段时间的调研后，我决定利用部分未被使用的寄存器，将时间戳储存在寄存器中，并在内核态中嵌入汇编语言进行读取。最终，这个方法被证实有效，我的同步IPC测试工作耗时一周也顺利完成，详细的测试的数据与分析也收获了向老师的认可。通过同步IPC的测试，我对ReL4的代码框架有了初步的认识，但离有能力进行系统调用的实现还有一定距离。

在完成了同步IPC的测试后，我就集中精力准备北航的考研复试去了，因此异步IPC的测试工作也就搁置了。

## 第三章 异步系统调用框架开发

### 3.1 跑通基本流程

当我结束考研复试的工作后，已经是4月1日了，当时学长已经完成了异步IPC的测试实验。在完成了学校的中期工作后，我开始完成毕业设计的最终内容——开发异步系统调用框架。由于内核可以抽象为IPC的某一端，因此异步系统调用的设计结构与异步IPC相似。因此，我先在学长的帮助下详细阅读了异步IPC的实现代码，并整理了异步IPC的学习文档。了解了异步IPC的工作原理，以此为参照，我计划先实现异步系统调用的基本流程，即用户态可以调用异步系统调用并接收响应。异步系统调用部分学长已经完成了部分内容，但是这部分内容是学长早期完成的，其中调用的许多接口已经被弃用，无法编译运行。因此，我首先对这部分代码进行了适配，使其适应最新的数据结构与相关方法。

在完成了适配工作后，用户态的基本流程已经完成了。接下来就是内核实现了。

我首先完善注册异步系统调用的内核函数。首先在内核态中给为系统调用的注册流程添加了注册用户态中断发送端的流程。由于考虑到用户态发送端的sender_id与内核协程对应，因此，我修改了用户态中断发送端的注册接口，使其返回sender_id，并将id作为入参传递给了内核协程。由于tcb与内核协程对应，因此tcb的引用也要作为入参传递给协程，而生成协程返回的协程id将被写入tcb的有关字段中。

然后，我开始完善内核协程的实现。这部分内容在相对简单，只要用无限循环的方式反复读取共享内存SyscallBuffer中的请求并处理，处理完成后判断用户态协程的状态并发送用户态中断即可。由于目前只需要跑通基本流程，因此无需处理。在完成了这部分内容后，用户态可以正常注册异步系统调用并向内核发送请求。

随后，还需要解决向用户态发送用户态中断的问题，我阅读了用户态中断的有关文档，理解了其中各个数据结构的作用，并参照网卡接口设计完成用户态中断发送函数。

紧接着，为了让用户态程序可以唤醒内核协程，我在系统中新增了一个系统调用，并将其在用户态进行了封装，供用户态程序调用。该系统调用可以读取tcb中保存的内核协程id并唤醒对应的协程。

最后，我设置内核在时钟中断到来时运行内核协程。理论上，到这个时候，异步系统调用的基本流程算是完成了。但是在运行的时候却出现了内核态无法获取用户态请求的问题。经过排查，发现是内核态共享内存SyscallBuffer的实现与用户态的不一致的原因，经过适配后，用户态和内核态可以按照设计方案进行正常交互并输出预期的debug内容。到此为止，异步系统调用基本流程的实现算是完成了。

### 3.2 翻译系统调用

实现了基本流程后，下面的任务就是要对ReL4中的部分系统调用进行异步化改造。我与学长商量了待翻译的系统调用名单。而在翻译其他系统调用之前，我先写了两个控制台输出的系统调用PutChar、PutString练手。

而其余部分内容的难点在于如何读懂原有系统调用是如何进行参数传递与参数解析的。在学长的指导下，我以RISCVPageGetAddress这个系统调用作为切入点，反复检验它在用户态的实现以及内核态的实现。我发现，RISCVPageGetAddress需要在frame（表征物理页）上实现invoke trait，并位invoke传入封装了系统调用的闭包。这些操作会将frame的capability都传入内核，内核解码后通过有关函数获取其物理地址。在知道了这些内容后，我仿照原有的实现方法，先实现了AsyncMessageLabel枚举类表示不同的系统调用，并将frame的capability作为入参写入请求中。在内核中，我也仿照原有的同步系统同调用实现完成了对capability的解码，并调用原有的函数进行了物理地址的获取并给用户态返回响应。结果表明这样的方法是有效的。（后来，我将ReL4的同步系统调用实现方式进行了分析整理，并写入了论文中。）

为了方便后续规范异步系统调用的参数传递方式，我在文档中新增了说明内容，并不断更新新增的系统调用的参数传递方式。

在翻译剩余的系统调用时，我也按照上述的方法，不断阅读内核态和用户态的相关代码。最终，我找到了翻译规律：**有关内核对象的系统调用都以内核对象的capability作为service，需要首先解析，后续内容可以参考原有实现；而对于部分有两个内核对象进行交互的系统调用，而需要额外解析一个capability。**此外，我还参考了ReL4原有的分级decode结构，复用原有的一部分代码，降低了异步系统调用的冗余代码规模。到了5月1日时，翻译工作也步入尾声了。

## 第四章 论文撰写与答辩准备

### 4.1 论文撰写

5.1日后，我的工作重心就转移到论文撰写上了。按照向老师的要求，我首先提交了论文大纲，随后按照大纲按部就班地完成。

在5月10日时，课题组进行了本科毕设运行结果的演示会。我演示了PutChar、PutString、RISCVPageGetAddress、UntypedRetype、RISCVPageMap、RISCVPageUnmap等系统调用的正确性。演示结束后，向老师和陆老师都认为，需要演示性能来清晰地展示异步系统调用的优越性，这样可以简单明了地让不是做系统方面的老师了解异步系统调用的好处。因此，我开始着手设计基于内存映射的实验场景，并计算异步系统调用性能以作为实验的一部分。

终于，在5月14号时，我完成了论文的第一稿，并提交给向老师检阅。向老师仔细地阅读了我的论文，并在5月15日给出了详细的修改意见：

1. 标题太长了，我的建议是“基于用户态中断的异步系统调用设计与实现”。
2. 摘要表述有些乱。每一句话要说完整。你的工作是“设计和实现了一种异步系统调用机制”，在摘要需要简要地说明你是如何做的，有什么效果。
3. 所有引用需要注明出处。如图2-1和2-2。
4. 每一章的标题中可以用冒号。如“第二章：预备概念与技术”。
5. 第三章还可以介绍一下reL4现在的系统调用实现。
6. 第四章说得太简要，这一章还需要论述你的做法的原因和好处。不能只是流水账。
7. 第五章可以在图4-1的基础上搞一个详细一些的实现图，这会让你的描述更好理解和强调你的优点。
8. 屏幕截图最好选用白色的背景，以改善黑白打印版本的效果。
9. 功能测试不仅需要说明系统调用的返回结果是正确的，还要验证异步系统调用没有特权级切换的行为。
10. 性能测试：需要尽可能在送审中包括这一部分的结果。
11. 参考文献需要是对论文工作有确实的参考价值的文献，不能列的文献没什么帮助，实际用的文献都没有列上。
12. 总体感觉是，你的程序比论文写得好。文字表达和内容组织还需要尽可能好好改一轮。

对照着向老师的意见，我一条条地修改我的论文，并在已经修改的意见上打勾来检测自己的进度。在修改的过程中，廖东海学长帮助我优化了异步系统调用的性能测试方案，我按照优化的版本进行了实验。结果显示，异步系统调用在性能上大幅优于同步系统调用，我喜出望外，将这部分写入论文中。

在5月19日，我完成了论文的盲审稿，在和罗熙同学互看论文确认无误后，我提交盲审稿，如释重负。

### 4.2 答辩准备

提交了盲审稿后，我便开始为答辩制作PPT与对应的讲稿。

一开始，向老师询问我们参与评优的意愿，并让我们若有评优的意愿则告知陆老师。我有争取优秀的，但自认为自己的工作并没有想象中的出色，因此不打算参与评优。等到盲审结果出来的时候，我只获得了一个A（82分）以及一个B（78分）的成绩，我有点失落，自认为评优无望，但还是认真准备了PPT并私下里进行了多次掐表试讲。

但在5月27日预答辩时，向老师和陆老师坚持认为我的工作内容不错，预答辩准备也很充分，再次鼓励我参与评优。最终，我下定决心参与评优，并按照答辩要求用心优化了PPT和演示视频。在答辩的前一天下午，陆老师还再次观看了我的试讲并对我的PPT以及演示内容提出了有针对性地意见，让我更好地突出重点来让答辩评委更直观地理解我的内容。在答辩的前一天晚上，我认为自己做足了准备，有机会冲击优秀。

在5月31日，我顺利地完成了答辩。但遗憾的是，答辩成绩大幅参考了盲审成绩，因此我最终还是无缘优秀。但不管怎么说，我在争取优秀的过程中也算尽到了最大的努力了。

## 完结

不知不觉中我的毕业设计工作也已经结束了，首先，我想向我的导师——陆慧梅老师表示最真挚的感谢和真诚的敬意。在本科三年级时，陆慧梅老师担任我操作系统课程的老师，她关心爱护同学，在课后也积极解答同学们的问题。她带领着我走入了操作系统课程的大门，让我对操作系统课程有了最初的了解与兴趣，也为我在日后选择操作系统作为研究生研究方向奠定了基础。自担任我的本科毕设指导老师以来，陆老师为我提供了优秀的科研资源，并帮助我推进毕业设计的工作，在重要的时间节点给出细致的指导。在毕业答辩临近之际，老师还鼓励我争优评优，帮助我修改完善答辩PPT。感谢陆老师对我本科毕业设计的审阅与指导，让我能完成这一大学期间最重要的学术任务！

其次，我还想感谢向勇老师。第一次见到向老师时，我就被他解决问题、安排工作时的干练所震撼。在每周的实验室例会上，向老师对我的毕设工作进行细致的指导和监督，并要求我们整理文档，实事求是地汇报已有的进展与成果。向老师的严格要求培养了我整理文档的好习惯，也让我明白了成为一个科研工作者需要有怎样的习惯和态度，这为我日后的研究生工作打下了良好的基础。向老师还愿意在百忙之中抽空阅读、指导我的论文工作，感动、感恩！感谢向老师一直以来的帮助、鼓励与认可！

感谢廖东海学长。学长自我进组准备毕设以来就尽心尽力地帮助我推进毕业设计工作。从ReL4操作系统运行环境的配置与搭建，到通过实验了解ReL4操作系统的代码内容，再到后来的异步系统调用框架的实现与调优，在整个过程中，学长都积极帮助我解决问题、及时解答我的疑惑。学长的帮助极大地减少了我的工作负担，帮助我少走了很多弯路，感激之情无以言表！

总而言之，感谢CSCW全体的老师、同学们，和你们一起合作、工作的半年时光是我人生中最宝贵的回忆，感谢相遇！

最后，我想向像曾经的我一样，对系统实验和比赛或是开源毕设感兴趣，却因为畏难而保持观望的同学们说：

rCore实验是不简单，开源毕设也确实有一定难度。但是rCore的课程和实现代码是非常规整且易懂的，逻辑链清晰。只要同学们下足功夫，是有很大概率可以很好地完成的。而开源毕设在向老师和陆老师的悉心指导下，完成起来也是非常顺利的，收获满满！希望后续的同学踊跃报名开源毕设！

## 附录

附录中是我在毕设工作中记录下的所有文档以及reL4微内核的相关代码仓库，希望能对后续的同学们有所帮助！

### 文档仓库

毕设仓库总链接：https://github.com/BIT-CWH/UndergraduateGraduationProject-2024-BIT-CWH

毕业论文：https://github.com/BIT-CWH/UndergraduateGraduationProject-2024-BIT-CWH/blob/main/%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87/10007_%E5%BE%AE%E5%86%85%E6%A0%B8%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9FReL4%E4%B8%AD%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E6%80%81%E4%B8%AD%E6%96%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%AE%BE%E8%AE%A1.pdf

答辩PPT：https://github.com/BIT-CWH/UndergraduateGraduationProject-2024-BIT-CWH/blob/main/%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87/%E9%99%88%E4%BC%9F%E8%B1%AA%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1%E7%AD%94%E8%BE%A9PPT.pdf

开题报告：https://github.com/BIT-CWH/UndergraduateGraduationProject-2024-BIT-CWH/blob/main/%E5%BC%80%E9%A2%98%E6%8A%A5%E5%91%8Av2-02-29.md

中期报告：https://github.com/BIT-CWH/UndergraduateGraduationProject-2024-BIT-CWH/blob/main/%E4%B8%AD%E6%9C%9F%E6%8A%A5%E5%91%8Av2-05-28.md

异步IPC与异步系统调用文档（含参数定义）：https://github.com/BIT-CWH/UndergraduateGraduationProject-2024-BIT-CWH/blob/main/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%BC%82%E6%AD%A5IPC%E4%B8%8E%E5%BC%82%E6%AD%A5%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8.md

ReL4环境配置帮助文档：https://ctrlz233s-organization.gitbook.io/sel4-analysis/dai-ma-zou-du/rel4test-riscvv-xia-bian-yi-huan-jing-da-jian

seL4教程文档（廖东海学长著）：https://ctrlz233s-organization.gitbook.io/sel4-analysis

### 代码仓库

root-task-demo:https://github.com/rel4team/rust-root-task-demo

reL4_kernel:https://github.com/rel4team/rel4_kernel

rust-sel4:https://github.com/rel4team/rust-sel4

seL4_c_impl:https://github.com/rel4team/seL4_c_impl